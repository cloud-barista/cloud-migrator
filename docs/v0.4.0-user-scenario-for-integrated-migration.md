# Integrated migration scenarios (Computing Infrastructure + Software)

The sequence diagrams represent user scenarios for integrated cloud migration, progressing from computing infrastructure migration to software migration. (ref: https://github.com/cloud-barista/cloud-migrator/discussions/25)

- **Precondition**: User has access to Cloud-Migrator web console and has both source infrastructure and software environments to migrate.
- **Postcondition**: Complete cloud migration with both infrastructure and software successfully migrated and operational on the target cloud environment.

> [!IMPORTANT]
> 원활한 Cloud-Migrator v0.4.0 통합 및 릴리스를 위한 Sequence Diagram 입니다.
> 이번 통합 테스트 및 릴리스를 위하여 사용자 시나리오 개선이 필요합니다. 🙏

> [!TIP]
> 수정/보완 사항들은 PR로 오픈하여 논의/협의를 진행해 주시기 바랍니다. 🙌

## Computing Infrastructure Migration Scenario

- Precondition: The user gets a recommended target infrastructure (i.e., target infra model) via Beetle.
- Postcondition: After migration, the user manages the migrated infrastructure via Tumblebug.
- Participants: User, Butterfly, Damselfly, Beetle, Tumblebug

> [!NOTE]
>
> - 컴퓨팅 인프라 마이그레이션의 전체 과정을 나타냅니다.
> - 주요 흐름:
>   - --> 소스 인프라 등록 및 정보 수집
>   - --> 타겟 인프라 모델 추천 및 생성
>   - --> 컴퓨팅 인프라 마이그레이션 실행
>   - --> Tumblebug을 통한 마이그레이션된 인프라 관리
> - 이 과정을 통해 생성된 MCI는 후속 소프트웨어 마이그레이션의 타겟 환경으로 사용됩니다.

```mermaid
sequenceDiagram
    participant User as "User"
    participant Browser as "Web Console"
    participant Butterfly as "Butterfly"
    participant Damselfly as "Damselfly"
    participant Beetle as "Beetle"
    participant Tumblebug as "Tumblebug"

	%% Step 0: User accesses the Computing Infra Migration View
    User->>Browser: Access the Computing Infra Migration View
    activate Browser
    Browser->>Butterfly: Request the Computing Infra Migration View
    activate Butterfly

    %% Retrieve the target models (cloud model) from Damselfly
    Butterfly->>Damselfly: API call to GET /damselfly/cloudmodel
    activate Damselfly
    Damselfly-->>Butterfly: Return the cloud model list
    deactivate Damselfly

    Butterfly-->>Browser: Respond with the view
    deactivate Butterfly
    Browser-->>User: Display Computing Infra Migration View
    deactivate Browser

    %% Select a target infra model (cloud model)
    User->>Browser: Select a target model
    activate Browser

    %% Execute Computing Infra Migration
    User->>Browser: Execute migration to cloud infrastructure
    Browser->>Butterfly: Request to migrate to cloud infrastructure
    activate Butterfly
    Butterfly->>Beetle: API call to POST /beetle/migration/ns/{nsId}/mci
    activate Beetle
    Beetle->>Tumblebug: Check if a namespace exists by API call to GET /tumblebug/ns/{nsId}
    activate Tumblebug
    Tumblebug-->>Beetle: Return the namespace info
    Beetle->>Tumblebug: Create vNet by API call to POST /tumblebug/ns/{nsId}/resources/vNet
    Tumblebug-->>Beetle: Return the vNet info
    Beetle->>Tumblebug: Create SSH key by API call to POST /tumblebug/ns/{nsId}/resources/sshKey
    Tumblebug-->>Beetle: Return the SSH key info
    Beetle->>Tumblebug: Create security group by API call to POST /tumblebug/ns/{nsId}/resources/securityGroup
    Tumblebug-->>Beetle: Return the security group info
    Beetle->>Tumblebug: Create MCI by API call to POST /tumblebug/ns/{nsId}/mci
    Tumblebug-->>Beetle: Return the migrated infra info
    deactivate Tumblebug
    Beetle-->>Butterfly: Return the migrated infra info
    deactivate Beetle
    Butterfly-->>Browser: Respond with the migrated infra info
    deactivate Butterfly
    Browser-->>User: Display the migrated infra info
    deactivate Browser

```

## Software Migration Scenario

- **Precondition**: The user gets a confirmed target software list (i.e., target sw model) via Grasshopper.
- **Postcondition**: 필요시 추가 바랍니다.

- Participants: Butterfly, Damselfly, Grasshopper, Honeybee, Tumblebug

```mermaid
sequenceDiagram
    participant User as User
    participant Browser as Web Console
    participant Butterfly as Butterfly
    participant Damselfly as Damselfly
    participant Grasshopper as Grasshopper
    participant Honeybee as Honeybee
    participant Beetle as Beetle
    participant Tumblebug as Tumblebug
    participant SourceVM as Source VM
    participant TargetVM as Target VM

    %% Step 0: User accesses the Software Migration View

    %% Request the view
    User->>Browser: Access the Software Migration View
    activate Browser
    Browser->>Butterfly: Request the Software Migration View
    activate Butterfly

    %% Retrieve a list of saved Target Software Models from Damselfly
    Butterfly->>Damselfly: API call to GET /damselfly/softwaremodel/target (list target software models)
    activate Damselfly
    Damselfly-->>Butterfly: Return list of saved target software models
    deactivate Damselfly

    %% Retrieve a list of migrated VM Infras (i.e., MCIs) from Tumblebug
    Note over Butterfly: Default nsId: mig01<br/>Available options: id, simple, status
    Butterfly->>Tumblebug: API call to GET /tumblebug/ns/{nsId}/mci
    activate Tumblebug
    Tumblebug-->>Butterfly: Return list of migrated VM Infras (or migrated VM Infra IDs by option)
    deactivate Tumblebug

    %% Display the view
    Butterfly-->>Browser: Respond with the view including target software models and migrated VM Infras (or migrated VM Infra IDs by option)
    deactivate Butterfly
    Browser-->>User: Display the Software Migration View including target software models and migrated VM Infras (or migrated VM Infra IDs by option)
    deactivate Browser

	opt Select and see a specific Target Software Model

		%% Request a specific target software model
	    User->>Browser: Select target software model for migration
	    activate Browser
	    Browser->>Butterfly: Send request with selected target software model ID
	    activate Butterfly

	    %% Retrieve specific Target Software Model
	    Butterfly->>Damselfly: API call to GET /damselfly/softwaremodel/target/{id} (retrieve specific target software model)
	    activate Damselfly
	    Damselfly-->>Butterfly: Return target software model data
	    deactivate Damselfly

	    %% Display the view
	    Butterfly-->>Browser: Respond with target software model data
	    deactivate Butterfly
	    Browser-->>User: Display selected target software model details
	    deactivate Browser
    end

	opt Select and see a specific migrated VM Infra

		%% Request a specific migrated VM Infra (i.e., MCI)
		User->>Browser: Select a migrated VM Infra
	    activate Browser
	    Browser->>Butterfly: Send request with nsId and mciId
	    activate Butterfly

		%% Retrieve the specific migrated VM infra (i.e., MCI)
		Note over Butterfly: Default nsId: mig01<br/>Default mciId: mmci01<br/>Available options: default, id, simple, status
	    Butterfly->>Tumblebug: API call to GET /tumblebug/ns/{nsId}/mci/{mciId}
	    activate Tumblebug
	    Tumblebug-->>Butterfly: Return the VM infra (or VM infra ID by option)
	    deactivate Tumblebug

		%% Display the view
	    Butterfly-->>Browser: Respond with the VM infra (or VM infra ID by option)
	    deactivate Butterfly
	    Browser-->>User: Display selected VM infra (or VM infra ID by option)
	    deactivate Browser
	end

    %% Step 1: Select the target software model and vm infra
    User->>Browser: Select the target software model and vm infra
    activate Browser

    %% Step 2: Execute software Migration

    %% Request
    User->>Browser: Execute software migration
    activate Browser
    Browser->>Butterfly: Request to migrate the softwares to the vm infra
    activate Butterfly
    Note over Butterfly: Path params: nsId, mciId<br/>Request body: a target sw model
    Butterfly->>Grasshopper: Execute software migration by API call to grasshopper/software/migrate
    activate Grasshopper

    %% Establish SSH connections with server in source computing environment
    Grasshopper->>Honeybee: Get source connection info
    activate Honeybee
    Note over Honeybee: Decrypt connection credentials<br/>using RSA private key
    Honeybee-->>Grasshopper: Return decrypted connection info
    deactivate Honeybee

    Grasshopper->>Tumblebug: Get target VMs connection info by API call to /tumblebug/ns/{nsId}/mci/{mciId}
    activate Tumblebug
    Tumblebug-->>Grasshopper: Return target VM infra info including VM info
    deactivate Tumblebug

    %% Execute migration for each software package in Target Software Model
    loop For each software package in Target Software Model

	    Grasshopper->>Grasshopper: Get ".vm[N].publicIP', ".vm[N].sshKeyId", and ".vm[N].label['sourceMachineId']" of each VM from the VM infra info

	    opt Get SSH Key once
		    Note over Grasshopper: Note: Currently, a single common SSH key is generated for each VM infrastructure.
		    Grasshopper->>Tumblebug: Get SSH key by API call to /tumblebug/ns/{nsId}/resources/sshKey/{sskKeyId}
		    activate Tumblebug
		    Tumblebug-->>Grasshopper: Return SSH key
		end

	    Grasshopper->>SourceVM: Establish SSH connection
	    activate SourceVM
	    Grasshopper->>TargetVM: Establish SSH connection
	    activate TargetVM


        Note over Grasshopper: Update status to "installing"<br/>Process software from target software model
        Grasshopper->>TargetVM: Run Ansible playbook for package installation
        TargetVM-->>Grasshopper: Return installation result

        Grasshopper->>SourceVM: Copy configuration files and data
        SourceVM-->>Grasshopper: Return copied files
        Grasshopper->>TargetVM: Transfer configuration files

        Grasshopper->>SourceVM: Extract service configuration
        SourceVM-->>Grasshopper: Return service settings
        Grasshopper->>TargetVM: Configure and start services
        TargetVM-->>Grasshopper: Return service status

        Note over Grasshopper: Update status to "finished" or "failed"
    end

    deactivate SourceVM
    deactivate TargetVM

    Grasshopper-->>Butterfly: Return the software migration results and status
    deactivate Grasshopper
    Butterfly-->>Browser: Respond with the software migration results and status
    deactivate Butterfly
    Browser-->>User: Display the software migration results and status
    deactivate Browser
```
